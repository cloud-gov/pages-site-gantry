---
// src/pages/[slug].astro
import Layout from "@/layouts/Layout.astro";
import PagesSection from "@/components/PagesSection.astro";
import payloadFetch from "@/utilities/payload-fetch";
import RichText from "@/components/RichText.astro";
import Media from "@/components/Media.astro";

const { slug } = Astro.params;

let page;

if (!Astro.isPrerendered) {
  const res = await payloadFetch(`pages?where[slug][equals]=${slug}&draft=true`);
  const { docs } = await res.json();
  if (!docs?.length) return Astro.redirect("/404");
  page = docs[0];
} else {
  const res = await payloadFetch(`pages?where[slug][equals]=${slug}`);
  const { docs } = await res.json();
  if (!docs?.length) return Astro.redirect("/404");
  page = docs[0];
}

export async function getStaticPaths() {
  const res = await payloadFetch(`pages?limit=1000&depth=0`);
  const { docs } = await res.json();
  return docs.map((p) => ({ params: { slug: p.slug }, props: { data: p } }));
}
---

<Layout title={page.title}>
  <PagesSection heading={page.title}>
    {page.image && (<Media media={page.image} />)}
    <RichText content={page.content} />
  </PagesSection>
</Layout>