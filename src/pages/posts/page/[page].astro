---
import Layout from "@/layouts/Layout.astro";
import CollectionItemList from "@/components/CollectionItemList.astro";
import PagesSection from "@/components/PagesSection.astro";
import type { CollectionEntry } from "astro:content";
import payloadFetch from "@/utilities/payload-fetch";
import { postsMapper } from "@/utilities/contentMapper";
import { paginate } from "@/utilities/pagination";
import PaginationNav from "@/components/PaginationNav.astro";
import { createPagingStaticPath } from "@/utilities/staticPath";

export const PAGE_SIZE = 10;
const siteUrl = import.meta.env.BASEURL || "";
const { page } = Astro.params;

const currentPage = parseInt(page) || 1;

const collectionName = "posts";
let posts: CollectionEntry<typeof collectionName>["data"][];

const response = await payloadFetch(`${collectionName}?draft=true`);
const postsData = await response.json();
posts = postsData.docs;

const sortedPosts = posts.sort((a, b) => {
  const dateA = new Date(a.publishedAt);
  const dateB = new Date(b.publishedAt);
  return dateB.getTime() - dateA.getTime();
})

const { totalPages, paginatedItems } = paginate(sortedPosts, currentPage, PAGE_SIZE);

const items = paginatedItems.map(postsMapper);

export const getStaticPaths = createPagingStaticPath(PAGE_SIZE , "posts");
export const prerender = true;
---

<Layout title="posts">
  <PagesSection heading="Posts">
    <CollectionItemList items={items}/>
    {posts.length >= PAGE_SIZE && (
      <PaginationNav currentPage={currentPage} totalPages={totalPages} basePath={`${siteUrl}/posts/page`} />
    )}
  </PagesSection>
</Layout>
