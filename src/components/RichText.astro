---
import {
  convertLexicalToHTML,
  type HTMLConvertersFunction,
} from "@payloadcms/richtext-lexical/html";
import type { DefaultNodeTypes } from "@payloadcms/richtext-lexical";
import sanitizeHtml from "sanitize-html";
import upload from "./RichTextConverters/upload";
import { getTextContent } from "./RichTextConverters/helpers";
import { table, tablerow, tablecell } from "./RichTextConverters/table";
import { processListBlock } from "./RichTextConverters/processList";

const { content, alert = false, identifier = undefined } = Astro.props;
const { textColor, linkColor } = identifier ?? {};
type NodeTypes = DefaultNodeTypes;

const htmlConverters: HTMLConvertersFunction<NodeTypes> = ({
  defaultConverters,
}) => {
  /*
   * Converters used inside each process item body (nested rich text)
   * Used to convert nested rich text inside Process List items without
   * re-invoking block converters (avoids recursion while preserving
   * heading/table/upload rules).
   */
  const nestedConverters: HTMLConvertersFunction<NodeTypes> = () => ({
    ...defaultConverters,
    upload: ({ node }) => upload({ node }),
    heading: ({ node }) => {
      const text = node.children?.map(getTextContent).join("") || "";
      const id = text
        .toLowerCase()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9-]/g, "");
      return `<${node.tag} id="${id}">${text}</${node.tag}>`;
    },
    table: ({ node }) => table({ node }),
    tablerow: ({ node }) => tablerow({ node }),
    tablecell: ({ node }) => tablecell({ node }),
  });

  return {
    ...defaultConverters,

    upload: ({ node }) => upload({ node }),

    heading: ({ node }) => {
      const text = node.children?.map(getTextContent).join("") || "";
      const id = text
        .toLowerCase()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9-]/g, "");
      return `<${node.tag} id="${id}">${text}</${node.tag}>`;
    },

    table: ({ node }) => table({ node }),
    tablerow: ({ node }) => tablerow({ node }),
    tablecell: ({ node }) => tablecell({ node }),

    blocks: {
      processList: ({ node }) =>
        processListBlock({
          node,
          htmlConverters: nestedConverters, // reuse pipeline for nested body
        }),
      // Add future blocks here:
      // otherBlockSlug: ({ node }) => renderOtherBlock(node, nestedConverters),
    },
  };
};

let rawHTML = convertLexicalToHTML({
  data: content,
  converters: htmlConverters,
});
---

<section
  class={`usa-prose ${alert && "alert-prose margin-y-0"} ${identifier && "identifier-prose margin-y-0"}`}
  style={`--textColor: var(${textColor}); --linkColor: var(${linkColor});`}
  set:html={sanitizeHtml(rawHTML, {
    allowedTags: sanitizeHtml.defaults.allowedTags.concat([
      "img",
      "svg",
      "use",
      "table",
      "thead",
      "tbody",
      "tr",
      "th",
      "td",
    ]),
    allowedClasses: {
      a: false,
      table: ["usa-table", "usa-table--striped"],
      div: false,
      h1: false,
      h2: false,
      h3: false,
      h4: ["usa-process-list__heading"],
      h5: false,
      h6: false,
      img: false,
      li: ["usa-process-list__item"],
      ol: ["usa-process-list"],
      p: false,
      span: false,
      ul: false,
    },
    allowedAttributes: {
      a: ["href", "name", "target", "download"],
      img: ["src", "alt"],
      use: ["href"],
      svg: ["class", "aria-hidden", "focusable", "role", "img"],
      h1: ["id"],
      h2: ["id"],
      h3: ["id"],
      h4: ["id", "class"],
      h5: ["id"],
      h6: ["id"],
      th: ["scope"],
      table: ["class"],
      ol: ["class"],
      li: ["class"],
    },
  })}
/>

<style lang="scss">
  :global(.alert-prose p) {
    max-width: 100%;
  }
  :global(.identifier-prose p) {
    font-weight: 700;
    color: var(--textColor);
  }
  :global(.identifier-prose a),
  :global(.identifier-prose a:hover) :global(.identifier-prose a:visited) {
    font-weight: 700;
    color: var(--linkColor) !important;
  }
</style>

<script>
  document.querySelectorAll(".alert-prose a").forEach((a) => {
    a.classList.add("usa-link");
  });
</script>
