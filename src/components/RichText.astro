---
import {
  convertLexicalToHTML,
  type HTMLConvertersFunction,
} from "@payloadcms/richtext-lexical/html";
import type { DefaultNodeTypes } from "@payloadcms/richtext-lexical";
import sanitizeHtml from "sanitize-html";
import upload from "./RichTextConverers/upload";

const { content, alert = false, identifier = undefined } = Astro.props;
const { textColor, linkColor } = identifier ?? {};

type NodeTypes = DefaultNodeTypes;

const htmlConverters: HTMLConvertersFunction<NodeTypes> = ({
  defaultConverters,
}) => {
  return {
    ...defaultConverters,
    upload: ({ node }) => upload({ node }),
    heading: ({ node }) => {
      const getTextContent = (child) => {
        if (child.text) return child.text;
        if (child.children) return child.children.map(getTextContent).join("");
        return "";
      };
      const text = node.children?.map(getTextContent).join("") || "";
      const id = text
        .toLowerCase()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9-]/g, "");
      return `<${node.tag} id="${id}">${text}</${node.tag}>`;
    },
  };
};
---

<section
  class={`usa-prose ${alert && "alert-prose margin-y-0"} ${identifier && "identifier-prose margin-y-0"}`}
  style={`--textColor: var(${textColor}); --linkColor: var(${linkColor});`}
  set:html={sanitizeHtml(
    convertLexicalToHTML({ data: content, converters: htmlConverters }),
    {
      allowedTags: sanitizeHtml.defaults.allowedTags.concat([
        "img",
        "svg",
        "use",
      ]),
      allowedClasses: {
        a: false,
        div: false,
        h1: false,
        h2: false,
        h3: false,
        h4: false,
        h5: false,
        h6: false,
        img: false,
        li: false,
        ol: false,
        p: false,
        span: false,
        ul: false,
      },
      allowedAttributes: {
        a: ["href", "name", "target", "download"],
        img: ["src", "alt"],
        use: ["href"],
        svg: ["class", "aria-hidden", "focusable", "role", "img"],
        h1: ["id"],
        h2: ["id"],
        h3: ["id"],
        h4: ["id"],
        h5: ["id"],
        h6: ["id"],
      },
    },
  )}
/>

<style lang="scss">
  :global(.alert-prose p) {
    max-width: 100%;
  }
  :global(.identifier-prose p) {
    font-weight: 700;
    color: var(--textColor);
  }
  :global(.identifier-prose a),
  :global(.identifier-prose a:hover) :global(.identifier-prose a:visited) {
    font-weight: 700;
    color: var(--linkColor) !important;
  }
</style>

<script>
  document.querySelectorAll(".alert-prose a").forEach((a) => {
    a.classList.add("usa-link");
  });
</script>
