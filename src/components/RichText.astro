---
import {
  convertLexicalToHTML,
  type HTMLConvertersFunction,
} from "@payloadcms/richtext-lexical/html";
import type { DefaultNodeTypes } from "@payloadcms/richtext-lexical";
import sanitizeHtml from "sanitize-html";
import upload from "./RichTextConverters/upload";
import { getTextContent } from "./RichTextConverters/helpers";
import { table, tablerow, tablecell } from "./RichTextConverters/table";
import { processListBlock } from "./RichTextConverters/processList";
import { accordionBlock } from "./RichTextConverters/accordion";
import { cardGridBlock } from "./RichTextConverters/cardGrid";

const { content, alert = false, identifier = undefined } = Astro.props;
const { textColor, linkColor } = identifier ?? {};
type NodeTypes = DefaultNodeTypes;

const htmlConverters: HTMLConvertersFunction<NodeTypes> = ({
  defaultConverters,
}) => {
  /*
   * Converters used inside each process item body (nested rich text)
   * Used to convert nested rich text inside Process List items without
   * re-invoking block converters (avoids recursion while preserving
   * heading/table/upload rules).
   */
  const nestedConverters: HTMLConvertersFunction<NodeTypes> = () => ({
    ...defaultConverters,
    upload: ({ node }) => upload({ node }),
    heading: ({ node }) => {
      const text = node.children?.map(getTextContent).join("") || "";
      const id = text
        .toLowerCase()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9-]/g, "");
      return `<${node.tag} id="${id}">${text}</${node.tag}>`;
    },
    table: ({ node }) => table({ node }),
    tablerow: ({ node }) => tablerow({ node }),
    tablecell: ({ node }) => tablecell({ node }),
  });

  return {
    ...defaultConverters,

    upload: ({ node }) => upload({ node }),

    heading: ({ node }) => {
      const text = node.children?.map(getTextContent).join("") || "";
      const id = text
        .toLowerCase()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9-]/g, "");
      return `<${node.tag} id="${id}">${text}</${node.tag}>`;
    },

    table: ({ node }) => table({ node }),
    tablerow: ({ node }) => tablerow({ node }),
    tablecell: ({ node }) => tablecell({ node }),

    blocks: {
      processList: ({ node }) =>
        processListBlock({
          node,
          htmlConverters: nestedConverters, // reuse pipeline for nested body
        }),
      accordion: ({ node }) =>
        accordionBlock({
          node,
          htmlConverters: nestedConverters,
        }),
      cardGrid: ({ node }) =>
        cardGridBlock({
          node,
        }),
      // Add future blocks here:
      // otherBlockSlug: ({ node }) => renderOtherBlock(node, nestedConverters),
    },
  };
};

let rawHTML = convertLexicalToHTML({
  data: content,
  converters: htmlConverters,
});
---

<section
  class={`usa-prose ${alert && "alert-prose margin-y-0"} ${identifier && "identifier-prose margin-y-0"}`}
  style={`--textColor: var(${textColor}); --linkColor: var(${linkColor});`}
  set:html={sanitizeHtml(rawHTML, {
    allowedTags: sanitizeHtml.defaults.allowedTags.concat([
      "img",
      "svg",
      "use",
      "table",
      "thead",
      "tbody",
      "tr",
      "th",
      "td",
      "button",
    ]),
    allowedClasses: {
      a: ["usa-button"],
      table: ["usa-table", "usa-table--striped"],
      div: [
        "grid-row",
        "grid-gap",
        "grid-col",
        "usa-accordion__content",
        "usa-prose",
        "usa-accordion",
        "usa-accordion--multiselectable",
        "usa-card__container",
        "usa-card__header",
        "usa-card__body",
        "usa-card__heading",
        "usa-card__footer",
        "usa-card__media",
        "usa-card__img",
        "tablet:grid-col",
        "usa-card",
        "usa-card-group",
        "usa-card--flag",
        "flex-1",
        "usa-card--media-right",
        "cardgrid-component",
      ],
      h1: false,
      h2: ["usa-process-list__heading", "usa-accordion__heading"],
      h3: ["usa-process-list__heading", "usa-accordion__heading"],
      h4: ["usa-process-list__heading", "usa-accordion__heading"],
      h5: ["usa-process-list__heading", "usa-accordion__heading"],
      h6: ["usa-process-list__heading", "usa-accordion__heading"],
      img: false,
      li: ["usa-process-list__item"],
      ol: ["usa-process-list"],
      p: false,
      span: false,
      ul: false,
      button: ["usa-accordion__button"],
    },
    allowedAttributes: {
      a: ["href", "name", "target", "download"],
      img: ["src", "alt"],
      use: ["href"],
      svg: ["class", "aria-hidden", "focusable", "role", "img"],
      h1: ["id", "class"],
      h2: ["id", "class"],
      h3: ["id", "class"],
      h4: ["id", "class"],
      h5: ["id", "class"],
      h6: ["id", "class"],
      th: ["scope"],
      table: ["class"],
      ol: ["class"],
      li: ["class"],
      button: ["class", "type", "aria-expanded", "aria-controls"],
      div: ["id", "data-allow-multiple"],
    },
  })}
/>

<style lang="scss">
  :global(.alert-prose p) {
    max-width: 100%;
  }
  :global(.identifier-prose p) {
    font-weight: 700;
    color: var(--textColor);
  }
  :global(.identifier-prose a),
  :global(.identifier-prose a:hover) :global(.identifier-prose a:visited) {
    font-weight: 700;
    color: var(--linkColor) !important;
  }

  :global(.cardgrid-component .usa-card__container) {
    border-radius: 0;
    border: none;
    background-color: #e6e6e2;
  }
  @media (min-width: 40em) {
    :global(.cardgrid-component.usa-card--flag .usa-card__media) {
      width: 11rem;
    }

    :global(.cardgrid-component.usa-card--flag .usa-card__img) {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }

    :global(.cardgrid-component.usa-card--flag .usa-card__header),
    :global(.cardgrid-component.usa-card--flag .usa-card__body),
    :global(.cardgrid-component.usa-card--flag .usa-card__footer) {
      margin-left: 11rem;
      padding-left: 1rem;
    }

    :global(.cardgrid-component.usa-card--flag .usa-card__header) {
      padding-top: 1rem;
    }
    :global(.cardgrid-component.usa-card--flag .usa-card__body) {
      padding-top: 0;
    }
  }
</style>

<script>
  document.querySelectorAll(".alert-prose a").forEach((a) => {
    a.classList.add("usa-link");
  });
</script>
