---
import Link from "./Link.astro";

interface Props {
  currentPage?: number;
  totalPages?: number;
  breadcrumbTitle?: string;
}

const {
  currentPage: currentPageProp,
  totalPages: totalPagesProp,
  breadcrumbTitle: breadcrumbTitleProp,
} = Astro.props;

const currentPath = Astro.url.pathname;
let cleanPath = currentPath;

const baseUrl = import.meta.env.BASEURL || "";
const branch = import.meta.env.BRANCH;

// Remove base URL if it's not just "/"
if (baseUrl && baseUrl !== "/") {
  cleanPath = currentPath.replace(baseUrl, "");
}

// Detect pagination and extract page number from URL
let currentPage: number | null = currentPageProp || null;
let totalPages: number | null = totalPagesProp || null;
let breadcrumbTitle: string | null = breadcrumbTitleProp || null;

// Extract page number from URL if not provided as prop (e.g., /resources/page/2)
if (!currentPage) {
  const pageMatch = cleanPath.match(/\/page\/(\d+)/);
  if (pageMatch) {
    currentPage = parseInt(pageMatch[1]);
  }
}

// Remove preview/branch segments if they exist; remove page segment and number
if (branch) {
  cleanPath = cleanPath
    .replace(`/preview/${branch}`, "")
    .replace("/page/", "/");
}
cleanPath = cleanPath
  .replace(/^\/preview\/[^\/]+/, "")
  .replace(/\/page\/\d+/, ""); // Remove /page/2, /page/3, etc.

// Split path into segments
const pathSegments = cleanPath.split("/").filter(Boolean);

const buildBreadcrumbs = () => {
  const breadcrumbs = [
    {
      text: "Home",
      url: "/",
      isCurrent: currentPath === "/" || cleanPath === "",
    },
  ];

  // Skip if we're on home page
  if (currentPath === "/" || cleanPath === "") {
    return breadcrumbs;
  }

  // Build breadcrumb trail
  let currentUrl = "";
  for (let i = 0; i < pathSegments.length; i++) {
    const segment = pathSegments[i];

    // Skip numeric segments (they're likely page numbers that weren't cleaned)
    if (/^\d+$/.test(segment)) {
      continue;
    }

    currentUrl += `/${segment}`;

    // Generate page title from URL segment
    let pageTitle =
      breadcrumbTitle && i === pathSegments.length - 1
        ? breadcrumbTitle
        : segment.replace(/-/g, " ").replace(/\b\w/g, (l) => l.toUpperCase());

    // Handle known collection pages
    if (
      [
        "reports",
        "resources",
        "news",
        "events",
        "posts",
        "leadership",
      ].includes(segment)
    ) {
      const collectionTitle =
        segment.charAt(0).toUpperCase() + segment.slice(1);
      breadcrumbs.push({
        text: collectionTitle,
        url: currentUrl,
        isCurrent: i === pathSegments.length - 1 && !currentPage,
      });
      continue;
    }

    breadcrumbs.push({
      text: pageTitle,
      url: currentUrl,
      isCurrent: i === pathSegments.length - 1 && !currentPage,
    });
  }

  // Check if URL contains /page/ segment (indicates user navigated via pagination)
  const hasPageSegment = /\/page\/\d+/.test(currentPath);

  // Add "Page x of x" if on paginated page
  if (currentPage && hasPageSegment) {
    const lastBreadcrumb = breadcrumbs[breadcrumbs.length - 1];
    if (lastBreadcrumb) {
      lastBreadcrumb.isCurrent = false;
    }
    breadcrumbs.push({
      text: totalPages
        ? `Page ${currentPage} of ${totalPages}`
        : `Page ${currentPage}`,
      url: currentPath,
      isCurrent: true,
    });
  }

  return breadcrumbs;
};

const breadcrumbs = buildBreadcrumbs();

// Don't show breadcrumbs on home page
if (currentPath === "/" || cleanPath === "" || cleanPath === "/") {
  return null;
}
---

<div class="grid-container">
  <nav class="usa-breadcrumb" aria-label="Breadcrumbs">
    <ol class="usa-breadcrumb__list">
      {
        breadcrumbs.map((crumb) => (
          <li class="usa-breadcrumb__list-item">
            {crumb.isCurrent ? (
              <span class="usa-breadcrumb__current" aria-current="page">
                {crumb.text}
              </span>
            ) : (
              <Link href={crumb.url} className="usa-breadcrumb__link">
                <span>{crumb.text}</span>
              </Link>
            )}
          </li>
        ))
      }
    </ol>
  </nav>
</div>
